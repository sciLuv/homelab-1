apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-db-credentials
  namespace: nextcloud
data:
  db-config.sh: |
    #!/bin/sh
    set -euo pipefail

    log() { printf "[%s] %s\n" "$(date +'%F %T')" "$*"; }
    as_www() { su -s /bin/sh www-data -c "$*"; }

    # Charger secrets Vault
    if [ -f /vault/secrets/creds.env ]; then
      set -a
      . /vault/secrets/creds.env
      set +a
      log "Secrets chargés depuis /vault/secrets/creds.env"
    else
      log "ERROR: /vault/secrets/creds.env introuvable"; exit 1
    fi

    # Normaliser (typo DATABSE vs DATABASE)
    : "${NEXTCLOUD_DATABSE_HOST:=${NEXTCLOUD_DATABASE_HOST:-}}"
    : "${NEXTCLOUD_DATABSE_USERNAME:=${NEXTCLOUD_DATABASE_USERNAME:-}}"
    : "${NEXTCLOUD_DATABSE_PASSWORD:=${NEXTCLOUD_DATABASE_PASSWORD:-}}"

    DB_HOST="${NEXTCLOUD_DATABSE_HOST:-}"
    DB_USER="${NEXTCLOUD_DATABSE_USERNAME:-}"
    DB_PASS="${NEXTCLOUD_DATABSE_PASSWORD:-}"
    DB_NAME="${NEXTCLOUD_DATABSE_USERNAME:-}"   # mapping souhaité
    ADMIN_USER="${NEXTCLOUD_USERNAME:-admin}"
    ADMIN_PASS="${NEXTCLOUD_PASSWORD:-changeme}"

    [ -n "$DB_HOST" ] || { log "ERROR: DB_HOST vide"; exit 1; }
    [ -n "$DB_USER" ] || { log "ERROR: DB_USER vide"; exit 1; }
    [ -n "$DB_PASS" ] || { log "ERROR: DB_PASS vide"; exit 1; }
    [ -n "$DB_NAME" ] || { log "ERROR: DB_NAME vide"; exit 1; }

    # Attendre que occ soit invocable
    i=0; until as_www "php /var/www/html/occ -V" >/dev/null 2>&1; do
      i=$((i+1)); [ $i -ge 60 ] && { log "ERROR: occ indisponible"; exit 1; }
      log "Attente d'occ..."; sleep 5
    done

    CONFIG_PHP="/var/www/html/config/config.php"
    INSTALLED=false
    if [ -f "$CONFIG_PHP" ] && grep -q "'installed' => true" "$CONFIG_PHP"; then
      INSTALLED=true
    fi

    if [ "$INSTALLED" = false ]; then
      log "Nextcloud non installé → lancement de maintenance:install"
      # Optionnel: backup si un vieux config.php traîne
      cp "$CONFIG_PHP" "${CONFIG_PHP}.bak.$(date +%Y%m%d%H%M%S)" 2>/dev/null || true

      set +e
      as_www "php /var/www/html/occ maintenance:install \
        --database pgsql \
        --database-host '${DB_HOST}' \
        --database-name '${DB_NAME}' \
        --database-user '${DB_USER}' \
        --database-pass '${DB_PASS}' \
        --admin-user '${ADMIN_USER}' \
        --admin-pass '${ADMIN_PASS}' \
        --data-dir '/var/www/html/data'"
      rc=$?
      set -e
      if [ $rc -ne 0 ]; then
        log "ERROR: maintenance:install a échoué (rc=$rc)"; exit $rc
      fi
      log "Installation terminée."
    else
      log "Nextcloud déjà installé."
    fi

    # Post-install: assurer la config DB (idempotent)
    log "Mise à jour DB via occ (idempotent)"
    as_www "php /var/www/html/occ config:system:set dbhost --value='${DB_HOST}'"
    as_www "php /var/www/html/occ config:system:set dbuser --value='${DB_USER}'"
    as_www "php /var/www/html/occ config:system:set dbpassword --value='${DB_PASS}'"
    as_www "php /var/www/html/occ config:system:set dbname --value='${DB_NAME}'"

    # Vérif
    VH="$(as_www "php /var/www/html/occ config:system:get dbhost" || true)"
    VU="$(as_www "php /var/www/html/occ config:system:get dbuser" || true)"
    VN="$(as_www "php /var/www/html/occ config:system:get dbname" || true)"
    log "Vérif -> dbhost='${VH}', dbuser='${VU}', dbname='${VN}', dbpassword='******'"
