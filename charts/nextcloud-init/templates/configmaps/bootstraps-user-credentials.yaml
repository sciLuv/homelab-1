apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-user-credentials
  namespace: nextcloud
data:
  user-config.sh: |
    #!/usr/bin/env bash
    #
    # Bootstrap Nextcloud via sidecar
    # - Lit les variables depuis l'ENV file injecté par Vault/OpenBao
    # - Attend que occ soit prêt
    # - Supprime 'admin' si présent
    # - Crée l'utilisateur cible ou met à jour son mot de passe
    #
    # Ce script est conçu pour tourner à CHAQUE démarrage du Pod (idempotent).
    #
    set -Eeuo pipefail
    IFS=$'\n\t'

    ########################
    # --- CONFIG PAR DEFAUT
    ########################
    : "${VAULT_ENV_FILE:=/vault/secrets/creds.env}"     # Chemin du fichier env injecté (annotation agent-inject-file-env)
    : "${OCC_BIN:=php /var/www/html/occ}"               # Commande occ
    : "${RUN_AS_USER:=www-data}"                        # Utilisateur Unix pour occ
    : "${WAIT_MAX_ATTEMPTS:=60}"                        # Nombre de tentatives pour attendre occ
    : "${WAIT_INTERVAL_SECONDS:=5}"                     # Intervalle entre tentatives
    : "${LOCK_FILE:=/tmp/nextcloud-bootstrap.lock}"     # Verrou pour éviter concurrence
    : "${ENABLE_ADMIN_DELETE:=true}"                    # Mettre à false pour ne pas toucher 'admin'

    ########################
    # --- LOGGING
    ########################
    log()  { echo "[$(date -Iseconds)] [bootstrap] $*"; }
    info() { log "INFO  $*"; }
    warn() { log "WARN  $*"; }
    err()  { log "ERROR $*"; }

    ########################
    # --- UTILITAIRES
    ########################
    as_www() {
      # Important : l'image nextcloud:apache utilise /bin/sh pour www-data
      # On passe une commande entière, en respectant les quotes de l'appelant.
      su -s /bin/sh "${RUN_AS_USER}" -c "$*"
    }

    run_with_retry() {
      # run_with_retry <max_attempts> <sleep_seconds> <commande...>
      local max="$1"; shift
      local sleep_s="$1"; shift
      local attempt=1
      while true; do
        if eval "$*"; then
          return 0
        fi
        if (( attempt >= max )); then
          return 1
        fi
        ((attempt++))
        sleep "${sleep_s}"
      done
    }

    wait_for_occ() {
      info "Attente de disponibilité d'occ (max ${WAIT_MAX_ATTEMPTS} tentatives, ${WAIT_INTERVAL_SECONDS}s intervalle)…"
      if run_with_retry "${WAIT_MAX_ATTEMPTS}" "${WAIT_INTERVAL_SECONDS}" \
           "as_www '${OCC_BIN} status' >/tmp/occ_status 2>&1"; then
        info "occ est prêt."
        return 0
      else
        err "occ n'a pas été prêt à temps. Dernière sortie :"
        cat /tmp/occ_status || true
        # On continue quand même pour émettre des logs utiles
        return 1
      fi
    }

    user_exists() {
      # user_exists <username>
      local u="$1"
      as_www "${OCC_BIN} user:info '${u}'" >/dev/null 2>&1
    }

    delete_user_if_present() {
      local u="$1"
      if user_exists "${u}"; then
        info "Utilisateur '${u}' détecté : tentative de suppression…"
        if as_www "${OCC_BIN} user:delete '${u}'" >/dev/null 2>&1; then
          info "Utilisateur '${u}' supprimé."
        else
          warn "Echec de suppression de '${u}'."
        fi
      else
        info "Utilisateur '${u}' non présent, rien à supprimer."
      fi
    }

    create_user() {
      # create_user <username> <display_name> <password>
      local u="$1" dn="$2" pw="$3"
      info "Création de l'utilisateur '${u}'…"
      if OC_PASS="${pw}" as_www "${OCC_BIN} user:add --password-from-env --display-name='${dn}' '${u}'" \
           >/dev/null 2>&1; then
        info "Utilisateur '${u}' créé."
        return 0
      else
        err "Création de l'utilisateur '${u}' échouée."
        return 1
      fi
    }

    reset_password() {
      # reset_password <username> <password>
      local u="$1" pw="$2"
      info "Mise à jour du mot de passe pour '${u}'…"
      if OC_PASS="${pw}" as_www "${OCC_BIN} user:resetpassword --password-from-env '${u}'" \
           >/dev/null 2>&1; then
        info "Mot de passe mis à jour pour '${u}'."
        return 0
      else
        err "Impossible de mettre à jour le mot de passe de '${u}'."
        return 1
      fi
    }

    ########################
    # --- MAIN
    ########################

    # 1) Verrouillage pour éviter un double-run si le sidecar redémarre vite.
    if command -v flock >/dev/null 2>&1; then
      exec 200>"${LOCK_FILE}"
      if ! flock -n 200; then
        warn "Un autre bootstrap est en cours. Abandon de ce run."
        exit 0
      fi
    else
      warn "flock indisponible, poursuite sans verrou (risque faible de concurrence)."
    fi

    info "Démarrage du bootstrap Nextcloud…"

    # 2) Charger les variables d'environnement issues d'OpenBao/Vault
    if [[ -f "${VAULT_ENV_FILE}" ]]; then
      # Exporter toutes les variables définies dans le fichier
      set -a
      # shellcheck disable=SC1090
      . "${VAULT_ENV_FILE}"
      set +a
      info "Variables chargées depuis ${VAULT_ENV_FILE}"
    else
      warn "Fichier d'env ${VAULT_ENV_FILE} introuvable. Vérifie l'annotation vault.hashicorp.com/agent-inject-file-env."
    fi

    # Variables requises pour ce bootstrap
    : "${NEXTCLOUD_USERNAME:?NEXTCLOUD_USERNAME manquant dans l'env}"
    : "${NEXTCLOUD_PASSWORD:?NEXTCLOUD_PASSWORD manquant dans l'env}"

    # 3) Attendre que occ soit prêt (sans faire échouer le script si ça dépasse)
    wait_for_occ || true

    # 4) Supprimer 'admin' si demandé
    if [[ "${ENABLE_ADMIN_DELETE}" == "true" ]]; then
      delete_user_if_present "admin"
    else
      info "Suppression de 'admin' désactivée (ENABLE_ADMIN_DELETE=false)."
    fi

    # 5) Créer ou mettre à jour l'utilisateur cible
    if user_exists "${NEXTCLOUD_USERNAME}"; then
      info "Utilisateur '${NEXTCLOUD_USERNAME}' existe déjà."
      # NOTE : Nextcloud/occ ne permet pas de comparer un mot de passe sans le connaître.
      # On réinitialise donc systématiquement au mot de passe fourni (idempotent et sûr).
      reset_password "${NEXTCLOUD_USERNAME}" "${NEXTCLOUD_PASSWORD}" || true
    else
      create_user "${NEXTCLOUD_USERNAME}" "${NEXTCLOUD_USERNAME}" "${NEXTCLOUD_PASSWORD}" || true
    fi

    info "Bootstrap terminé."
    exit 0
